# 3 用户认证机制

### 3.1 基于密码的安全验证

使用自动生成的**公钥-私钥对**来简单地加密网络连接，随后使用密码认证进行登录。具体过程如下：

* 客户端发送登录请求，`ssh user@hostname`
* 服务器接受请求，将服务器的公钥server\_rsa.pub发送给客户端
* 客户端输入密码，密码使用server\_rsa.pub加密后发送给服务器（敏感信息安全传输）
* 服务器接受加密后的密码，使用服务器私钥server\_rsa解密，匹配认证密码是否合法

至此，身份认证通过，然后是交换会话密钥（对称加密）

* 客户端生成会话数据加密session\_key， 使用server\_rsa.pub加密后传输给服务器（会话密钥）
* 服务器获取到后使用server\_rsa解密，得到session\_key

使用会话密钥对之后传递的数据进行加密。注：使用对称加密效率高。

* 客户端和服务器通过session\_key进行会话数据安全传输

\> 但是，这种认证方式无法避免#中间人攻击，可能会有别的服务器在冒充真正的服务器。

### 3.2 公钥身份认证

客户端生成**一对公钥和私钥**，并将自己的公钥复制到服务器上。客户端请求登录的时候，服务器会**随机生成一个字符串**并用客户端的公钥进行加密，客户端收到之后用自己的**私钥解密**后，再发送给服务器。服务器收到后进行比对，如果比对成功，就证明用户是可信的，直接允许登录，不再要求密码。从而避免了#中间人攻击。具体过程如下：

![authentication2022-03-10-23-51-29](https://linley.oss-cn-shanghai.aliyuncs.com/typora\_image/authentication2022-03-10-23-51-29.png)

基于密钥的安全验证简单的描述如图中所示。但在实际传输过程中所有的数据都是需要加密以保证数据传输安全，即同样会生成**会话密钥**，使用会话密钥**对传输数据进行加密**的过程。详细过程如下：

* 客户端发送登录请求，`ssh user@hostname`
* 服务器接受请求，将服务器的公钥服务器公钥发送给客户端
* 服务器生成会话ID(session id)，设为p，发送给客户端。
* 客户端生成会话密钥(session key)，设为q，并计算$$r=p\ xor\ q$$ [#什么是xor?](https://baike.baidu.com/item/%E5%BC%82%E6%88%96/10993677)
* 客户端将r用As进行加密，结果发送给服务器
* 服务器用服务器私钥进行解密，获得r
* 服务器进行$$r\ xor\ p$$的运算，获得q

至此，服务器和客户端都知道了会话密钥q，以后的传输数据都将被q加密。

* 服务器生成随机数X，并用ac加密后生成结果$S\_x$，发送给客户端
* 客户端使用客户端私钥解密$S\_x$得到x
* 客户端计算\$$q+x\$$的md5值\$$n(q+x)\$$，q为上一步得到的会话密钥
* 客户端将\$$n(q+x)\$$发送给服务器
* 服务器计算\$$q+x\$$的md5值\$$m(q+x)\$$
* 服务器比较\$$m(g+x)\$$和\$$n(g+x)\$$，两者相同则认证成功

至此，服务器和客户端认证通过，可以使用会话密钥进行加密和解密传输

* 客户端和服务器通过q进行会话数据安全传输
